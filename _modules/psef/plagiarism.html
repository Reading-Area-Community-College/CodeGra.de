

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>psef.plagiarism &mdash; CodeGrade v1.6.8 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v1.6.8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guides/getting-started-with-codegrade.html">Getting started with CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/creating-an-assignment.html">Create a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/creating-managing-and-using-snippets.html">Create, manage and use snippets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/checking-for-plagiarism.html">Check for plagiarism in a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/set-up-group-assignment.html">Set up a CodeGrade group assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/pass-back-grades-to-canvas-blackboard-moodle-brightspace.html">Pass back grades to Canvas, Blackboard, Moodle or Brightspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setup-password-for-codegrade-account.html">Set up a password for my CodeGrade account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/set-up-a-rubric-for-an-assignment.html">Set up a rubric for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/using-shortcuts.html">Using shortcuts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/dividing-submissions.html">Divide submissions over graders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/cannot-find-feature-in-codegrade.html">I cannot find a feature in CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setting-up-hand-in-requirements.html">Set up hand-in requirements for a CodeGrade assignment</a></li>
</ul>
<p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/overview.html">Overview of CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/codeviewer.html">Code Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/management.html">Course and Assignment Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/plagiarism.html">Plagiarism Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/groups.html">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/permissions.html">Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/preferences.html">Settings and Site Preferences</a></li>
<li class="toctree-l1"><a class="reference external" href="https://fs-docs.codegra.de">Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/lms.html">LMS Integration</a></li>
</ul>
<p class="caption"><span class="caption-text">About CodeGrade</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/about.html">About CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developerdocs.html">Developer documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CodeGrade</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../psef.html">psef</a> &raquo;</li>
        
      <li>psef.plagiarism</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for psef.plagiarism</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines all classes and function needed for the plagiarism checking</span>
<span class="sd">infrastructure.</span>

<span class="sd">The actual providers are located in the :mod:`psef.plagiarism_providers`</span>
<span class="sd">module.</span>

<span class="sd">SPDX-License-Identifier: AGPL-3.0-only</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>

<span class="kn">import</span> <span class="nn">structlog</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">files</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">helpers</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="init_app"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.init_app">[docs]</a><span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Initialize providers for the given flask app.</span>

<span class="sd">    :param: The flask app to initialize for.</span>
<span class="sd">    :returns: Nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">plagiarism_providers</span>
    <span class="n">plagiarism_providers</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span></div>


<div class="viewcode-block" id="OptionTypes"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.OptionTypes">[docs]</a><span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">OptionTypes</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes the type of the option</span>

<span class="sd">    :param multiselect: An option that should be one or more values from the</span>
<span class="sd">        ``possible_options`` list. It should be passed back as an array of</span>
<span class="sd">        values, not indices!.</span>
<span class="sd">    :param singleselect: The same as ``multiselect``, only it can be one value</span>
<span class="sd">        and it should be passed back as that value, not an array.</span>
<span class="sd">    :param numbervalue: An option that should be a number.</span>
<span class="sd">    :param strvalue: An option that should be a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">multiselect</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">singleselect</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">numbervalue</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">strvalue</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span></div>


<div class="viewcode-block" id="Option"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.Option">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Option</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a single option for a plagiarism provider.</span>

<span class="sd">    :param name: The name of the option.</span>
<span class="sd">    :param title: The title of the option.</span>
<span class="sd">    :param description: The description of the options.</span>
<span class="sd">    :param type: The type of this option.</span>
<span class="sd">    :param mandatory: If this is ``True`` the plagiarism provider can only</span>
<span class="sd">        function when this option is supplied.</span>
<span class="sd">    :param possible_options: Possible values for this option. This value has to</span>
<span class="sd">        be a non empty sequence if the ``type`` is ``multiselect`` or</span>
<span class="sd">        ``singleselect``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">OptionTypes</span>
    <span class="n">mandatory</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">possible_options</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
    <span class="n">placeholder</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">OptionTypes</span><span class="o">.</span><span class="n">multiselect</span><span class="p">,</span>
            <span class="n">OptionTypes</span><span class="o">.</span><span class="n">singleselect</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">del</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;possible_options&#39;</span><span class="p">]</span>

        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="process_output_csv"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.process_output_csv">[docs]</a><span class="k">def</span> <span class="nf">process_output_csv</span><span class="p">(</span>
    <span class="n">lookup_map</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">old_submissions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Container</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">file_tree_lookup</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">files</span><span class="o">.</span><span class="n">FileTree</span><span class="p">],</span>
    <span class="n">csvfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">PlagiarismCase</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Process the outputted csv file into plagiarism cases with matches.</span>

<span class="sd">    Each line of the csvfile should have the following items separated by</span>
<span class="sd">    ``delimiter``:</span>

<span class="sd">    1. The top level directory of the first submission;</span>
<span class="sd">    2. The top level directory of the second submission;</span>
<span class="sd">    3. The amount that submission 1 matched with submission 2;</span>
<span class="sd">    4. The amount that submission 2 matched with submission 1;</span>
<span class="sd">    5. The relative path of first file that matched;</span>
<span class="sd">    6. The start position were the match for the first file begins;</span>
<span class="sd">    7. The end position were the match for the first file ends;</span>
<span class="sd">    8. The relative path of second file that matched;</span>
<span class="sd">    9. The start position were the match for the second file begins;</span>
<span class="sd">    10. The end position were the match for the second file ends;</span>

<span class="sd">    Fields 5-10 can occur any number of times, but have to occur at least once.</span>

<span class="sd">    :param lookup_map: A dictionary that should map the name of each toplevel</span>
<span class="sd">        directory to a submission id.</span>
<span class="sd">    :param old_submissions: Some sort of set that contains the ids of all</span>
<span class="sd">        submissions that are old. If a match between two of those submissions</span>
<span class="sd">        is found this match in not inserted into the database.</span>
<span class="sd">    :param file_tree_lookup: A lookup that maps submission ids to their file</span>
<span class="sd">        trees.</span>
<span class="sd">    :param csvfile: The location of the csv file that follow the above format.</span>
<span class="sd">    :param delimiter: The delimiter used for this csv file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">models</span><span class="o">.</span><span class="n">PlagiarismCase</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dir1</span><span class="p">,</span> <span class="n">dir2</span><span class="p">,</span> <span class="n">match1</span><span class="p">,</span> <span class="n">match2</span><span class="p">,</span> <span class="o">*</span><span class="n">matches</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span>
            <span class="n">f</span><span class="p">,</span>
            <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">sub1_id</span> <span class="o">=</span> <span class="n">lookup_map</span><span class="p">[</span><span class="n">dir1</span><span class="p">]</span>
            <span class="n">sub2_id</span> <span class="o">=</span> <span class="n">lookup_map</span><span class="p">[</span><span class="n">dir2</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">sub1_id</span> <span class="ow">in</span> <span class="n">old_submissions</span> <span class="ow">and</span> <span class="n">sub2_id</span> <span class="ow">in</span> <span class="n">old_submissions</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">sub1_id</span> <span class="o">==</span> <span class="n">sub2_id</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Found plagiarism within a submission&#39;</span><span class="p">,</span>
                    <span class="n">submission_id</span><span class="o">=</span><span class="n">sub1_id</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">tup</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">sub1_id</span><span class="p">,</span> <span class="n">sub2_id</span><span class="p">))))</span>
            <span class="k">if</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Duplicate plagiarism case in csv file&#39;</span><span class="p">,</span>
                    <span class="n">submission1_id</span><span class="o">=</span><span class="n">sub1_id</span><span class="p">,</span>
                    <span class="n">submission2_id</span><span class="o">=</span><span class="n">sub2_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">new_case</span> <span class="o">=</span> <span class="n">seen</span><span class="p">[</span><span class="n">tup</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">match_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">match1</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">match2</span><span class="p">))</span>
                <span class="n">match_avg</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">match1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">match2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">new_case</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PlagiarismCase</span><span class="p">(</span>
                    <span class="n">work1_id</span><span class="o">=</span><span class="n">sub1_id</span><span class="p">,</span>
                    <span class="n">work2_id</span><span class="o">=</span><span class="n">sub2_id</span><span class="p">,</span>
                    <span class="n">match_avg</span><span class="o">=</span><span class="n">match_avg</span><span class="p">,</span>
                    <span class="n">match_max</span><span class="o">=</span><span class="n">match_max</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">tup</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_case</span>

            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">matches</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">6</span><span class="p">):</span>
                <span class="n">fname1</span><span class="p">,</span> <span class="n">fstart1</span><span class="p">,</span> <span class="n">fend1</span><span class="p">,</span> <span class="n">fname2</span><span class="p">,</span> <span class="n">fstart2</span><span class="p">,</span> <span class="n">fend2</span> <span class="o">=</span> <span class="n">match</span>
                <span class="n">f_id1</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">search_path_in_filetree</span><span class="p">(</span>
                    <span class="n">file_tree_lookup</span><span class="p">[</span><span class="n">sub1_id</span><span class="p">],</span>
                    <span class="n">fname1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">f_id2</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">search_path_in_filetree</span><span class="p">(</span>
                    <span class="n">file_tree_lookup</span><span class="p">[</span><span class="n">sub2_id</span><span class="p">],</span>
                    <span class="n">fname2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">new_case</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">PlagiarismMatch</span><span class="p">(</span>
                        <span class="n">file1_id</span><span class="o">=</span><span class="n">f_id1</span><span class="p">,</span>
                        <span class="n">file2_id</span><span class="o">=</span><span class="n">f_id2</span><span class="p">,</span>
                        <span class="n">file1_start</span><span class="o">=</span><span class="n">fstart1</span><span class="p">,</span>
                        <span class="n">file1_end</span><span class="o">=</span><span class="n">fend1</span><span class="p">,</span>
                        <span class="n">file2_start</span><span class="o">=</span><span class="n">fstart2</span><span class="p">,</span>
                        <span class="n">file2_end</span><span class="o">=</span><span class="n">fend2</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_case</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="PlagiarismProvider"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.PlagiarismProvider">[docs]</a><span class="k">class</span> <span class="nc">PlagiarismProvider</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The (abstract) base class every plagiarism provider should inherit from.</span>

<span class="sd">    The main functionality each implementation should provide are options and</span>
<span class="sd">    mapping those options to a program call (the actual plagiarism checking</span>
<span class="sd">    should be done in an external program). This program is called from a</span>
<span class="sd">    celery task and should produce log on ``stdout`` and ``stderr``, and a csv</span>
<span class="sd">    file that should follow the format expected by</span>
<span class="sd">    :func:`process_output_csv`. If the csv needs to be transformed this can be</span>
<span class="sd">    done using :func:`PlagiarismProvider.transform_csv` which is called just</span>
<span class="sd">    before the csv file is processed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PlagiarismProvider.supports_base_code"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.PlagiarismProvider.supports_base_code">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_base_code</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Does this provider support base code.</span>

<span class="sd">        :returns: A boolean indicating if the provider supports base code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PlagiarismProvider.transform_csv"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.PlagiarismProvider.transform_csv">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_csv</span><span class="p">(</span><span class="n">csvfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Transform the csv file outputed by the plagiarism checker to</span>
<span class="sd">            something that is readable by :func:`process_output_csv`.</span>

<span class="sd">        :param csvfile: The location of the old csv file.</span>
<span class="sd">        :returns: The location of the csv file that can be processed by</span>
<span class="sd">            :func:`process_output_csv`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">csvfile</span></div>

<div class="viewcode-block" id="PlagiarismProvider.supports_progress"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.PlagiarismProvider.supports_progress">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">supports_progress</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Does this provider support showing progress to the user.</span>

<span class="sd">        :returns: ``True`` if this provider supports progress detection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="PlagiarismProvider.get_progress_from_line"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.PlagiarismProvider.get_progress_from_line">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_progress_from_line</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Get the progress of the plagiarism provider.</span>

<span class="sd">        This function is called for every line of output produced by the</span>
<span class="sd">        provider. This should return two values, the first value should be the</span>
<span class="sd">        amount of submissions processed and the second the total amount. These</span>
<span class="sd">        values first indicate that this many submissions have been parsed. When</span>
<span class="sd">        the first value is equal to the second value it means that all</span>
<span class="sd">        submissions have been parsed and that comparing has started.</span>

<span class="sd">        You should return ``None`` if the given line doesn&#39;t contain progress</span>
<span class="sd">        information.</span>

<span class="sd">        :returns: Two values or ``None`` as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="PlagiarismProvider.get_options"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.PlagiarismProvider.get_options">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_options</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Option</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all possible options for this provider.</span>

<span class="sd">        This function needs to be implemented by the provider.</span>

<span class="sd">        :returns: A list of possible options for this plagiarism provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">matches_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The path of the csv file that contains the matches in the correct</span>
<span class="sd">        format.</span>

<span class="sd">        This function needs to be implemented by the provider.</span>

<span class="sd">        :returns: The path of the result csv relative to the</span>
<span class="sd">            ``{ result_dir }``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_multiselect</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span> <span class="n">Option</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if a given value ``v`` is valid for the given multiselect.</span>

<span class="sd">        :param val: The object to check.</span>
<span class="sd">        :param opt: The multiselect to check for.</span>
<span class="sd">        :returns: A list of all errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;The value for &quot;</span><span class="si">{opt.name}</span><span class="s1">&quot; should &#39;</span>
                <span class="n">f</span><span class="s1">&#39;be a list but is a &quot;{type(val)}&quot;&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="c1"># This is only None for things that are not selectables</span>
                <span class="k">assert</span> <span class="n">opt</span><span class="o">.</span><span class="n">possible_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">possible_options</span><span class="p">:</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">f</span><span class="s1">&#39;The value &quot;</span><span class="si">{item}</span><span class="s1">&quot; is not &#39;</span>
                        <span class="n">f</span><span class="s1">&#39;possible for &quot;</span><span class="si">{opt.name}</span><span class="s1">&quot;&#39;</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">errs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_singlevalue</span><span class="p">(</span>
        <span class="n">val</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">opt</span><span class="p">:</span> <span class="n">Option</span><span class="p">,</span>
        <span class="n">typ</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">IsInstanceType</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if a given value ``v`` is valid for the given singlevalue.</span>

<span class="sd">        :param val: The object to check.</span>
<span class="sd">        :param opt: The single to check for.</span>
<span class="sd">        :param typ: The required type for the value.</span>
<span class="sd">        :returns: A list of all errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">f</span><span class="s1">&#39;The type of &quot;</span><span class="si">{opt.name}</span><span class="s1">&quot; is not correct &#39;</span>
                    <span class="n">f</span><span class="s1">&#39;(it should be a &quot;{&quot; or &quot;.join(map(str, typ))}&quot;, &#39;</span>
                    <span class="n">f</span><span class="s1">&#39;but it is a &quot;{type(val)}&quot;).&#39;</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="PlagiarismProvider.set_options"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.PlagiarismProvider.set_options">[docs]</a>    <span class="k">def</span> <span class="nf">set_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">JSONType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the options for this plagiarism provider.</span>

<span class="sd">        :param values: The options for this run, this can still include the</span>
<span class="sd">            ``provider`` and ``old_assignments`` key.</span>
<span class="sd">        :returns: Nothing.</span>

<span class="sd">        :raises APIException: If the values are not the correct format, if</span>
<span class="sd">            mandatory options miss, if an option has an incorrect value or if</span>
<span class="sd">            given value was not recognized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">complete_values</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">ensure_json_dict</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">complete_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;provider&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;old_assignments&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;has_base_code&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;has_old_submissions&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_options</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">opt</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">OptionTypes</span><span class="o">.</span><span class="n">multiselect</span><span class="p">:</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_multiselect</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">opt</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">OptionTypes</span><span class="o">.</span><span class="n">singleselect</span><span class="p">:</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_multiselect</span><span class="p">([</span><span class="n">val</span><span class="p">],</span> <span class="n">opt</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">{</span>
                    <span class="n">OptionTypes</span><span class="o">.</span><span class="n">strvalue</span><span class="p">,</span>
                    <span class="n">OptionTypes</span><span class="o">.</span><span class="n">numbervalue</span><span class="p">,</span>
                <span class="p">}:</span>
                    <span class="n">typ</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">IsInstanceType</span>
                    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">OptionTypes</span><span class="o">.</span><span class="n">strvalue</span><span class="p">:</span>
                        <span class="n">typ</span> <span class="o">=</span> <span class="nb">str</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">typ</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_singlevalue</span><span class="p">(</span>
                        <span class="n">val</span><span class="p">,</span>
                        <span class="n">opt</span><span class="p">,</span>
                        <span class="n">typ</span><span class="p">,</span>
                    <span class="p">))</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">mandatory</span><span class="p">:</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">f</span><span class="s1">&#39;The option &quot;</span><span class="si">{opt.name}</span><span class="s1">&quot; is not present but is mandatory&#39;</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">missed_key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">missed_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">missed_key</span><span class="p">]</span>
            <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;The option &quot;</span><span class="si">{missed_key}</span><span class="s1">&quot; with &#39;</span>
                <span class="n">f</span><span class="s1">&#39;value &quot;</span><span class="si">{missed_value}</span><span class="s1">&quot; is unknown.&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">errs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;The given config is not valid for this provider&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Some options are invalid or missing&#39;</span><span class="p">,</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_PARAM</span><span class="p">,</span>
                <span class="mi">400</span><span class="p">,</span>
                <span class="n">invalid_options</span><span class="o">=</span><span class="n">errs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_provider_values</span><span class="p">(</span><span class="n">complete_values</span><span class="p">)</span></div>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_set_provider_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">helpers</span><span class="o">.</span><span class="n">JSONType</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the provided values as options.</span>

<span class="sd">        When this function is called you can assume that the provided values</span>
<span class="sd">        are valid.</span>

<span class="sd">        This function needs to be implemented by the provider.</span>

<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="PlagiarismProvider.get_program_call"><a class="viewcode-back" href="../../psef_api/psef.html#psef.plagiarism.PlagiarismProvider.get_program_call">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_program_call</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get a program call list that runs the checker.</span>

<span class="sd">        This list is used as the first argument to</span>
<span class="sd">        :func:`subprocess.check_output`, with ``shell=False``. It can contain</span>
<span class="sd">        two special entries:</span>

<span class="sd">        1. ``&#39;{ restored_dir }&#39;``: This will be replaced with the location of</span>
<span class="sd">        the files that need to be checked.</span>

<span class="sd">        2. ``&#39;{ result_dir }&#39;``: This will be replaced with the directory where</span>
<span class="sd">        the result csv needs to be placed.</span>

<span class="sd">        This function needs to be implemented by the provider.</span>

<span class="sd">        :returns: A list as that can be used with</span>
<span class="sd">            :func:`subprocess.check_output`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, CodeGrade

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>